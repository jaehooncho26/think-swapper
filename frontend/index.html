<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>the think swapper</title>
  <style>
    @font-face {
      font-family: 'Qahiri';
      src: url('Qahiri-Regular.ttf') format('truetype');
      font-weight: lighter;
      font-style: normal;
    }
    :root { --bg:#000000; --card:#f59e47; --muted:#f59e47; --text:#e8edff; }
    body {
      margin:0;
      font-family:'Qahiri',system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background-image: url("background.jpg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      color: var(--text);
    }
    .wrap { max-width:880px; margin:32px auto; padding:0 16px; }
    .card { background:#000000; border:0px solid #f59e47; border-radius:16px; padding:16px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
    .grid { display:grid; gap:12px; }
    .g3 { grid-template-columns:repeat(3,1fr); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .title-container { display:flex; justify-content:center; align-items:center; margin-top:50px; margin-bottom:75px; }
    .description-container { display:flex; justify-content:center; align-items:center; margin-top:20px; margin-bottom:20px; }
    .title-img { width:100%; max-width:500px; height:auto; object-fit:contain; }
    .description-img { width:100%; max-width:250px; height:auto; object-fit:contain; }
    .description2-img { width:100%; max-width:125px; height:auto; object-fit:contain; }
    .muted { color:#FFFFFF; font-weight:bold; font-size:40px; }
    .pill { display:inline-block; padding:5px 30px; border:2px solid #9c6025; border-radius:999px; font-family:monospace; background:#edba87; color:#000000; }
    .right { text-align:right; }
    .text-value-pair { display:flex; gap:8px; justify-content:center; align-items:center; }
    .text-descriptions { display:flex; gap:8px; margin-top:100px; margin-bottom:80px; margin-left:200px; margin-right:200px; justify-content:center; align-items:center; }
    .text-titles { display:flex; gap:8px; margin-top:50px; margin-bottom:20px; margin-left:200px; margin-right:200px; justify-content:center; align-items:center; }

    /* Logo + Label */
    .token-label { display:flex; align-items:center; gap:8px; }
    .token-label img { height:40px; width:auto; }

    /* Transactions */
    .tx-title { font-size:28px; font-weight:bold; margin:4px 0 12px; text-align:center; }
    .tx-list { display:flex; flex-direction:column; gap:10px; }
    .tx-row {
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap; padding:10px 12px;
      border:0px solid #9c6025; border-radius:12px; background:#0a0a0a;
    }
    .tx-time { font-family:monospace; opacity:0.9; }
    .tx-pills { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .tx-empty { text-align:center; opacity:0.8; padding:12px 0; }
    .tx-note { font-size:12px; opacity:0.7; margin-top:6px; text-align:center; }
  </style>
</head>
<body>
  <div class="title-container">
    <img src="thinkswapper.png" alt="GalaSwap Logo" class="title-img">
  </div>
  <div class="description-container">
    <img src="price.png" alt="Price section" class="description-img">
  </div>

  <div class="wrap">
    <!-- Prices -->
    <div class="grid g3" style="margin-top:14px;">
      <div class="card">
        <div class="text-value-pair">
          <div class="token-label">
            <img src="usdclogo.png" alt="USDC logo">
            <div class="muted">USDC:</div>
          </div>
          <div id="pUSDC" class="pill">—</div>
        </div>
      </div>
      <div class="card">
        <div class="text-value-pair">
          <div class="token-label">
            <img src="galalogo.png" alt="GALA logo">
            <div class="muted">GALA:</div>
          </div>
          <div id="pGALA" class="pill">—</div>
        </div>
      </div>
      <div class="card">
        <div class="text-value-pair">
          <div class="token-label">
            <img src="ethlogo.png" alt="ETH logo">
            <div class="muted">ETH:</div>
          </div>
          <div id="pETH" class="pill">—</div>
        </div>
      </div>
    </div>

    <div class="description-container">
      <img src="thinkerswallet.png" alt="Wallet section" class="description2-img">
    </div>

    <!-- Balances -->
    <div class="grid g3" style="margin-top:14px;">
      <div class="card">
        <div class="text-value-pair">
          <div class="token-label">
            <img src="usdclogo.png" alt="USDC logo">
            <div class="muted">USDC:</div>
          </div>
          <div id="bUSDC" class="pill">N/A</div>
        </div>
      </div>
      <div class="card">
        <div class="text-value-pair">
          <div class="token-label">
            <img src="galalogo.png" alt="GALA logo">
            <div class="muted">GALA:</div>
          </div>
          <div id="bGALA" class="pill">N/A</div>
        </div>
      </div>
      <div class="card">
        <div class="text-value-pair">
          <div class="token-label">
            <img src="ethlogo.png" alt="ETH logo">
            <div class="muted">ETH:</div>
          </div>
          <div id="bETH" class="pill">N/A</div>
        </div>
      </div>
    </div>

    <!-- Wallet Total -->
    <div class="card" style="margin-top:14px;">
      <div class="row" style="justify-content:center;">
        <div class="text-value-pair">
          <div class="muted">Total:</div>
          <div id="bTOTAL" class="pill">N/A</div>
        </div>
      </div>
    </div>

    <!-- Transactions -->
    <div class="card" style="margin-top:14px;">
      <div class="tx-title">Transactions</div>
      <div id="txList" class="tx-list">
        <div class="tx-empty">No transactions yet.</div>
      </div>
      <div id="txNote" class="tx-note"></div>
    </div>

    <h1 class="text-descriptions"></h1>
  </div>

  <script>
    const API_BASE = '/.netlify/functions/sidecar';
    const DISPLAY_TZ = 'America/Los_Angeles'; // force Pacific time

    const $ = id => document.getElementById(id);
    const pGALA=$('pGALA'), pUSDC=$('pUSDC'), pETH=$('pETH');
    const bUSDC=$('bUSDC'), bGALA=$('bGALA'), bETH=$('bETH'), bTOTAL=$('bTOTAL');
    const txList=$('txList'), txNote=$('txNote');

    // ---------- formatting helpers ----------
    const fmtUSD = (n) => {
      if (n == null || !isFinite(n)) return '—';
      return '$' + n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 6 });
    };
    const toNum = (v) => { const n = Number(v); return isFinite(n) ? n : 0; };

    // Parse seconds/ms/ISO → epoch ms
    function parseTsAny(t) {
      if (t == null) return null;
      if (typeof t === 'number') return t < 2e10 ? Math.round(t*1000) : Math.round(t);
      if (typeof t === 'string') {
        const n = Number(t);
        if (Number.isFinite(n)) return n < 2e10 ? Math.round(n*1000) : Math.round(n);
        const ms = Date.parse(t); // ISO
        if (Number.isFinite(ms)) return ms;
      }
      return null;
    }

    function fmtTime(anyTs) {
      const ms = parseTsAny(anyTs);
      if (!ms) return '—';
      const d = new Date(ms);
      if (isNaN(d.getTime())) return '—';
      return d.toLocaleString(undefined, {
        year:'numeric', month:'short', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit',
        timeZone: DISPLAY_TZ,
        timeZoneName:'short'
      });
    }

    let latestPrices = { GALA: null, ETH: null, USDC: 1 };
    let lastBalances = { GUSDC: null, GALA: null, GWETH: null };
    let lastTxsData = [];

    async function fetchPrices() {
      const r = await fetch(`${API_BASE}/prices`);
      if (!r.ok) throw new Error('prices ' + r.status);
      const j = await r.json();
      const P = j.prices || {};
      latestPrices = {
        GALA: toNum(P.GALA),
        ETH:  toNum(P.ETH),
        USDC: toNum(P.USDC) || 1
      };
      pGALA.textContent = fmtUSD(latestPrices.GALA);
      pUSDC.textContent = fmtUSD(latestPrices.USDC);
      pETH .textContent = fmtUSD(latestPrices.ETH);
    }

    async function fetchBalances() {
      const r = await fetch(`${API_BASE}/assets`);
      if (!r.ok) {
        bUSDC.textContent = 'N/A';
        bGALA.textContent = 'N/A';
        bETH .textContent = 'N/A';
        bTOTAL.textContent = 'N/A';
        throw new Error('assets ' + r.status);
      }
      const j = await r.json();
      const arr = Array.isArray(j.tokens) ? j.tokens : [];
      const map = new Map(arr.map(t => [String(t.symbol).toUpperCase(), String(t.quantity)]));
      const qUSDC = map.get('GUSDC');
      const qGALA = map.get('GALA');
      const qWETH = map.get('GWETH');
      bUSDC.textContent = qUSDC ?? 'N/A';
      bGALA.textContent = qGALA ?? 'N/A';
      bETH .textContent = qWETH ?? 'N/A';
      lastBalances = {
        GUSDC: qUSDC != null ? toNum(qUSDC) : null,
        GALA:  qGALA != null ? toNum(qGALA)  : null,
        GWETH: qWETH != null ? toNum(qWETH) : null
      };
      if (lastBalances.GUSDC == null && lastBalances.GALA == null && lastBalances.GWETH == null) {
        bTOTAL.textContent = 'N/A';
      } else {
        const total =
          (lastBalances.GUSDC ?? 0) +
          (lastBalances.GALA  ?? 0) * (latestPrices.GALA || 0) +
          (lastBalances.GWETH ?? 0) * (latestPrices.ETH  || 0);
        bTOTAL.textContent = isNaN(total) ? 'N/A' : fmtUSD(total);
      }
    }

    // ---------- Transactions UI ----------
    function renderTxs(txs, note='') {
      if (!Array.isArray(txs) || txs.length === 0) {
        txList.innerHTML = '<div class="tx-empty">No transactions yet.</div>';
        txNote.textContent = note || '';
        lastTxsData = [];
        return;
      }
      lastTxsData = txs.slice();

      const sorted = txs.slice().sort((a,b) => {
        const ta = parseTsAny(a.ts ?? a.time ?? a.timestamp ?? a.meta?.timestamp) || 0;
        const tb = parseTsAny(b.ts ?? b.time ?? b.timestamp ?? b.meta?.timestamp) || 0;
        return tb - ta;
      });

      txList.innerHTML = sorted.map(tx => {
        const rawTs = tx.ts ?? tx.time ?? tx.timestamp ?? tx.meta?.timestamp;
        const label = fmtTime(rawTs) || '—';
        const after = tx.after || {};
        const usdcStr = after.GUSDC ?? after.USDC ?? '0';
        const galaStr = after.GALA  ?? '0';
        const wethStr = after.GWETH ?? after.WETH ?? '0';
        const usdc = toNum(usdcStr), gala = toNum(galaStr), weth = toNum(wethStr);

        // Prefer historical total from sidecar; otherwise show ≈ using current prices
        const hasHist = tx.usdTotalAt != null && isFinite(Number(tx.usdTotalAt));
        const histTotal = hasHist ? Number(tx.usdTotalAt) : null;
        const approxNow = (usdc) + (gala * (latestPrices.GALA || 0)) + (weth * (latestPrices.ETH || 0));
        const totalLabel = hasHist ? fmtUSD(histTotal) : ('≈' + fmtUSD(approxNow));

        const id = tx.meta?.txId || tx.meta?.hash || '';
        const ms = parseTsAny(rawTs);
        const iso = ms ? new Date(ms).toISOString() : '';

        return `
          <div class="tx-row" title="${iso ? `ISO: ${iso}` : ''}">
            <div class="tx-time">${label}${id ? ` — <span style="opacity:.7">(${id.slice(0,6)}…${id.slice(-6)})</span>` : ''}</div>
            <div class="tx-pills">
              <span class="pill">USDC: ${usdcStr}</span>
              <span class="pill">GALA: ${galaStr}</span>
              <span class="pill">ETH: ${wethStr}</span>
              <span class="pill">Total @ time: ${totalLabel}</span>
            </div>
          </div>
        `;
      }).join('');

      txNote.textContent = note || ( 'Totals use historical prices when available; otherwise an approximate current-price total (shown with “≈”). Times shown in ' + DISPLAY_TZ + '.' );
    }

    // If some rows lack a valid timestamp but have a txId/hash, ask the sidecar to resolve it.
    async function fillMissingTimestamps(txs) {
      const needs = (txs || []).filter(tx => {
        const raw = tx.ts ?? tx.time ?? tx.timestamp ?? tx.meta?.timestamp;
        const hasTime = !!parseTsAny(raw);
        const hasId = !!(tx.meta?.txId || tx.meta?.hash);
        return !hasTime && hasId;
      });
      if (needs.length === 0) return;

      const slice = needs.slice(0, 5);
      await Promise.all(slice.map(async (tx) => {
        const id = tx.meta?.txId || tx.meta?.hash;
        try {
          const r = await fetch(`${API_BASE}/tx-time?txId=${encodeURIComponent(id)}`);
          if (!r.ok) return;
          const j = await r.json();
          if (j && j.timestamp) {
            tx.ts = j.timestamp;
            tx.meta = { ...(tx.meta||{}), resolvedChannel: j.channel, block: j.block };
          }
        } catch {}
      }));

      renderTxs(lastTxsData);
    }

    // Fallback: one snapshot if /txs is empty
    async function fallbackSnapshot() {
      try {
        const r = await fetch(`${API_BASE}/assets`);
        if (!r.ok) throw new Error('assets ' + r.status);
        const j = await r.json();
        const arr = Array.isArray(j.tokens) ? j.tokens : [];
        const map = new Map(arr.map(t => [String(t.symbol).toUpperCase(), String(t.quantity)]));
        const row = {
          ts: Date.now(),
          after: {
            GUSDC: map.get('GUSDC') ?? '0',
            GALA:  map.get('GALA')  ?? '0',
            GWETH: map.get('GWETH') ?? '0'
          },
          meta: { seeded: true }
        };
        renderTxs([row], 'Showing current snapshot (no tx history available yet).');
      } catch {
        renderTxs([], 'No transactions yet.');
      }
    }

    async function fetchTxs() {
      // try enriched endpoint first
      try {
        let r = await fetch(`${API_BASE}/txs/usd?limit=50`);
        if (!r.ok) {
          // fall back to plain txs
          r = await fetch(`${API_BASE}/txs?limit=50`);
        }
        if (!r.ok) throw new Error('txs ' + r.status);
        const j = await r.json();
        const list = Array.isArray(j.txs) ? j.txs : [];
        if (list.length === 0) {
          await fallbackSnapshot();
        } else {
          renderTxs(list);
          fillMissingTimestamps(list);
        }
      } catch (e) {
        console.error(e);
        await fallbackSnapshot();
      }
    }

    async function refreshAll() {
      try {
        await fetchPrices();
        await fetchBalances();
        await fetchTxs();
      } catch (e) {
        console.error(e);
      }
    }

    setInterval(() => fetchPrices().catch(()=>{}), 5000);
    setInterval(() => fetchBalances().catch(()=>{}), 10000);
    setInterval(() => fetchTxs().catch(()=>{}), 15000);
    refreshAll();
  </script>

</body>
</html>
