<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>the think swapper</title>
  <style>
    /* Font */
    @font-face {
      font-family: 'Qahiri';
      src: url('Qahiri-Regular.ttf') format('truetype');
      font-weight: lighter;
      font-style: normal;
      font-display: swap;
    }

    /* Theme */
    :root{
      --bg:#000000; 
      --card:#0a0a0a; 
      --muted:#f59e47; 
      --text:#e8edff;
      --ring:#9c6025;
      --radius:16px;
      --shadow:0 6px 24px rgba(0,0,0,.25);
      --space:12px;
      --wrap-max:880px;
    }

    /* Base */
    html,body{height:100%;}
    body{
      margin:0; color:var(--text); font-family:'Qahiri',system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background-image:url("background.jpg");
      background-size:cover; background-position:center; background-repeat:no-repeat; 
    }
    /* Readability overlay on top of bg (helps on mobile text contrast) */
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.55));
      z-index:-1;
    }

    .wrap{max-width:var(--wrap-max); margin:32px auto; padding:0 clamp(12px, 3vw, 20px);} 

    .card{background:var(--card); border:0 solid var(--muted); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow);} 

    /* Grid system */
    .grid{display:grid; gap:var(--space);} 
    .g3{grid-template-columns:repeat(3, minmax(0,1fr));}

    /* Responsive breakpoints */
    @media (max-width: 1024px){
      .g3{grid-template-columns:repeat(2, minmax(0,1fr));}
    }
    @media (max-width: 640px){
      .g3{grid-template-columns:1fr;}
      .wrap{margin:20px auto;}
    }

    /* Flex rows */
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center;}

    /* Title image */
    .title-container{display:flex; justify-content:center; align-items:center; margin:50px auto 60px; padding:0 12px;}
    .title-img{width:100%; max-width:min(500px, 90vw); height:auto; object-fit:contain;}
    @media (max-width:640px){
      .title-container{margin:28px auto 36px;}
      .title-img{max-width:360px;}
    }

    /* Typographic scales use clamp for mobile */
    .muted{color:#fff; font-weight:bold; font-size:clamp(18px, 5vw, 32px);} 
    .tx-title{font-size:clamp(20px, 6vw, 36px); font-weight:bold; margin:24px 0; text-align:center;}
    .tx-note{font-size:clamp(11px, 2.7vw, 12px); opacity:0.7; margin-top:6px; text-align:center;}

    /* Token rows */
    .text-value-pair{display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; text-align:center;}
    .text-value-pair img{height:40px; width:auto;}
    @media (max-width:640px){ .text-value-pair img{height:28px;} }

    /* Pills are finger-friendly */
    .pill{display:inline-block; padding:10px 18px; border:2px solid var(--ring); border-radius:999px; font-family:monospace; background:#edba87; color:#000; line-height:1; min-height:40px;}
    @media (max-width:640px){ .pill{padding:10px 14px; min-height:40px; font-size:clamp(14px, 3.8vw, 16px);} }

    /* Transactions */
    .tx-list{display:flex; flex-direction:column; gap:10px;}
    .tx-row{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; padding:10px 12px; border:0 solid var(--ring); border-radius:12px; background:#0a0a0a;}
    .tx-time{font-family:monospace; opacity:0.9;}
    .tx-empty{text-align:center; opacity:0.8; padding:12px 0;}

    /* Link-as-button */
    .link-row{display:flex; justify-content:center;}
    .pill-link{text-decoration:none; color:#000;}
    .pill-link:active{transform:translateY(1px);} /* mobile tap feedback */

    /* Make totals block stack nicely on small screens */
    @media (max-width:640px){
      .totals-row{flex-direction:column; align-items:center;}
    }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{animation:none!important; transition:none!important;}
    }

    /* iOS safe-areas */
    .safe-bottom{padding-bottom:env(safe-area-inset-bottom);}
  </style>
</head>
<body>
  <div class="title-container">
    <img src="thinkswapper.png" alt="GalaSwap Logo" class="title-img"/>
  </div>

  <div class="tx-title">the price of the coin</div>
  <div class="wrap safe-bottom">
    <!-- Prices -->
    <div class="grid g3" style="margin-top:14px;">
      <div class="card"><div class="text-value-pair"><img src="usdtlogo.png" alt="USDT logo"><div class="muted">USDT:</div><div id="pUSDT" class="pill">—</div></div></div>
      <div class="card"><div class="text-value-pair"><img src="galalogo.png" alt="GALA logo"><div class="muted">GALA:</div><div id="pGALA" class="pill">—</div></div></div>
      <div class="card"><div class="text-value-pair"><img src="ethlogo.png" alt="ETH logo"><div class="muted">ETH:</div><div id="pETH" class="pill">—</div></div></div>
    </div>

    <div class="tx-title">Wallet <span style="opacity:.8; font-size:.8em;">(takes a few seconds to load)</span></div>

    <!-- Balances -->
    <div class="grid g3" style="margin-top:14px;">
      <div class="card"><div class="text-value-pair"><img src="usdtlogo.png" alt="USDT logo"><div class="muted">USDT:</div><div id="bUSDT" class="pill">N/A</div></div></div>
      <div class="card"><div class="text-value-pair"><img src="galalogo.png" alt="GALA logo"><div class="muted">GALA:</div><div id="bGALA" class="pill">N/A</div></div></div>
      <div class="card"><div class="text-value-pair"><img src="ethlogo.png" alt="ETH logo"><div class="muted">ETH:</div><div id="bETH" class="pill">N/A</div></div></div>
    </div>

    <!-- Wallet Total + P&L -->
    <div class="card" style="margin-top:14px;">
      <div class="row totals-row" style="justify-content:center;">
        <div class="row" style="gap:18px; justify-content:center;">
          <div class="text-value-pair"><div class="muted">Total:</div><div id="bTOTAL" class="pill">N/A</div></div>
          <div class="text-value-pair"><div class="muted">P&amp;L:</div><div id="bPNL" class="pill">$0.00</div></div>
        </div>
      </div>
    </div>

    <div class="tx-title">started off with $500. How much will the think Swapper end up with?</div>

    <!-- Transactions -->
    <div class="card" style="margin-top:14px;">
      <div class="tx-title">Transactions</div>
      <div id="txList" class="tx-list">
        <div class="link-row">
          <a class="pill pill-link" href="https://galascan.gala.com/wallet/eth%7CE7DFA9CeCdD6f13Dbe31ea9Ed0880FFFF05Dab42" target="_blank" rel="noopener noreferrer">
            View full history on GalaScan →
          </a>
        </div>
      </div>
      <div id="txNote" class="tx-note">Live history coming soon.</div>
    </div>
  </div>

  <script>
    const API_BASE = '/.netlify/functions/sidecar';
    const $ = id => document.getElementById(id);

    const pGALA=$('pGALA'), pUSDT=$('pUSDT'), pETH=$('pETH');
    const bUSDT=$('bUSDT'), bGALA=$('bGALA'), bETH=$('bETH'), bTOTAL=$('bTOTAL'), bPNL=$('bPNL');

    const fmtUSD = (n) => isFinite(n) ? '$'+n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:6}) : '—';
    const toNum = (v) => { const n=Number(v); return isFinite(n)?n:0; };

    let latestPrices = { GALA:null, ETH:null, USDT:1 };
    let lastBalances = { GUSDT:null, GALA:null, GWETH:null };

    // ==== P&L baseline ====
    const PNL_KEY = 'pnlBaselineUSD';
    let STARTING_USD = Number(localStorage.getItem(PNL_KEY) ?? 500);
    function setBaseline(v) {
      const n = Number(v);
      if (Number.isFinite(n)&&n>=0){STARTING_USD=n; localStorage.setItem(PNL_KEY,String(n)); refreshAll();}
    }
    function fmtPNL(usd){
      const sign = usd>=0?'+':'';
      return `${sign}$${usd.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;
    }
    function colorPNL(el,pnl){
      if(!el) return;
      if(pnl>0.0001){el.style.background='#b6f3c9';el.style.borderColor='#2c8e4e';}
      else if(pnl<-0.0001){el.style.background='#ffd6d6';el.style.borderColor='#b84a4a';}
      else{el.style.background='#edba87';el.style.borderColor:'#9c6025';}
    }

    async function fetchPrices() {
      try {
        const r=await fetch(`${API_BASE}/prices`); if(!r.ok)throw new Error();
        const j=await r.json(); const P=j.prices||{};
        latestPrices={ GALA:toNum(P.GALA), ETH:toNum(P.ETH), USDT:toNum(P.USDT)||1 };
        pGALA.textContent=fmtUSD(latestPrices.GALA);
        pUSDT.textContent=fmtUSD(latestPrices.USDT);
        pETH.textContent=fmtUSD(latestPrices.ETH);
      } catch(e){console.error(e);} }

    async function fetchBalances() {
      try {
        const r=await fetch(`${API_BASE}/assets`); if(!r.ok)throw new Error();
        const j=await r.json(); const arr=Array.isArray(j.tokens)?j.tokens:[];
        const map=new Map(arr.map(t=>[String(t.symbol).toUpperCase(),String(t.quantity)]));
        const qUSDT=map.get('GUSDT'); const qGALA=map.get('GALA'); const qWETH=map.get('GWETH');
        bUSDT.textContent=qUSDT??'...'; bGALA.textContent=qGALA??'...'; bETH.textContent=qWETH??'...';
        lastBalances={ GUSDT:qUSDT!=null?toNum(qUSDT):null, GALA:qGALA!=null?toNum(qGALA):null, GWETH:qWETH!=null?toNum(qWETH):null };
        const total=(lastBalances.GUSDT??0)+(lastBalances.GALA??0)*(latestPrices.GALA||0)+(lastBalances.GWETH??0)*(latestPrices.ETH||0);
        bTOTAL.textContent=isNaN(total)?'...':fmtUSD(total);

        if(Number.isFinite(total)){
          const pnl=total-STARTING_USD;
          bPNL.textContent=`${fmtPNL(pnl)} (${((pnl/STARTING_USD)*100).toFixed(2)}%)`;
          colorPNL(bPNL,pnl);
        } else {
          bPNL.textContent='...'; colorPNL(bPNL,0);
        }
      } catch(e){console.error(e); bUSDT.textContent=bGALA.textContent=bETH.textContent=bTOTAL.textContent='...';}
    }

    async function refreshAll(){ await fetchPrices(); await fetchBalances(); }
    // Slightly longer polling on mobile can save battery; keep defaults reasonable
    setInterval(()=>fetchPrices().catch(()=>{}),5000);
    setInterval(()=>fetchBalances().catch(()=>{}),10000);
    refreshAll();
  </script>
</body>
</html>
